var $=Object.defineProperty,K=Object.defineProperties;var F=Object.getOwnPropertyDescriptors;var S=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,z=Object.prototype.propertyIsEnumerable;var k=(r,a,s)=>a in r?$(r,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[a]=s,g=(r,a)=>{for(var s in a||(a={}))V.call(a,s)&&k(r,s,a[s]);if(S)for(var s of S(a))z.call(a,s)&&k(r,s,a[s]);return r},x=(r,a)=>K(r,F(a));var j=(r,a,s)=>new Promise((n,l)=>{var p=o=>{try{m(s.next(o))}catch(c){l(c)}},d=o=>{try{m(s.throw(o))}catch(c){l(c)}},m=o=>o.done?n(o.value):Promise.resolve(o.value).then(p,d);m((s=s.apply(r,a)).next())});import{j as e,D as M,h as q,d as w,T,A,$ as G,L as H,k as J,a0 as N,l as O,B as E,a1 as Q,a2 as X,a3 as Y,n as Z,K as _}from"./mui-vendor-40f14a38.js";import{r as h}from"./react-vendor-db9ce8bf.js";import{a as U,l as v}from"./index-15b0d453.js";import"./socket-vendor-e2a77347.js";import"./xterm-vendor-a786ee91.js";function oe({open:r,onClose:a,version:s}){const[n,l]=h.useState("starting"),[p,d]=h.useState([{id:"backup",label:"Backing up configuration",status:"pending"},{id:"download",label:"Downloading update",status:"pending"},{id:"install",label:"Installing dependencies",status:"pending"},{id:"build",label:"Building frontend",status:"pending"},{id:"restart",label:"Restarting service",status:"pending"},{id:"verify",label:"Verifying installation",status:"pending"}]),[m,o]=h.useState(null),[c,b]=h.useState(0),P=90;h.useEffect(()=>{r&&B()},[r]);const B=()=>j(this,null,function*(){l("updating"),o(null);try{(yield U.post("/api/update-execute")).data.success?(C(),setTimeout(()=>L(),65e3)):(o("Failed to start update"),l("error"))}catch(t){v.error("Update execution failed:",t),o(t.message),l("error")}}),C=()=>{[5e3,15e3,25e3,5e4,7e4].forEach((i,u)=>{setTimeout(()=>{d(y=>y.map((W,I)=>x(g({},W),{status:I<u?"completed":I===u?"active":"pending"})))},i)})},L=()=>j(this,null,function*(){v.info("Starting to poll for service availability"),l("polling"),f()}),f=()=>j(this,null,function*(){if(c>=P){d(t=>t.map(i=>x(g({},i),{status:i.status==="active"?"error":i.status}))),o("Update is taking longer than expected. The update may still be in progress. Please wait a moment and reload the page."),l("timeout");return}try{v.debug(`Polling attempt ${c+1}/${P}`);const t=yield U.get("/api/update-check",{timeout:2e3,validateStatus:()=>!0});v.debug(`Poll response status: ${t.status}`),t.status===200?(d(i=>i.map((u,y)=>x(g({},u),{status:y<5?"completed":y===5?"active":"pending"}))),setTimeout(()=>{d(i=>i.map(u=>x(g({},u),{status:"completed"}))),l("completed"),setTimeout(()=>{window.location.reload()},1500)},1e3)):(b(i=>i+1),setTimeout(()=>f(),2e3))}catch(t){b(i=>i+1),setTimeout(()=>f(),2e3)}}),R=t=>{switch(t){case"completed":return e.jsx(_,{color:"success"});case"active":return e.jsx(Z,{size:20});case"error":return e.jsx(Y,{color:"error"});default:return e.jsx(X,{color:"disabled"})}},D=()=>p.filter(i=>i.status==="completed").length/p.length*100;return e.jsx(M,{open:r,onClose:n==="completed"||n==="error"?a:void 0,maxWidth:"sm",fullWidth:!0,disableEscapeKeyDown:n==="updating"||n==="polling",children:e.jsxs(q,{sx:{py:4},children:[e.jsxs(w,{sx:{textAlign:"center",mb:3},children:[e.jsxs(T,{variant:"h5",gutterBottom:!0,children:["Updating to v",s]}),n==="updating"&&e.jsx(T,{variant:"body2",color:"text.secondary",children:"Please wait while MuxTerm is being updated..."}),n==="polling"&&e.jsxs(T,{variant:"body2",color:"text.secondary",children:["Waiting for service to restart... (",c,"/",P,")"]}),n==="completed"&&e.jsx(A,{severity:"success",sx:{mt:2},children:"Update completed! Reloading..."}),(n==="error"||n==="timeout")&&e.jsx(A,{severity:"error",sx:{mt:2},children:m||"Update failed. Please check the logs."})]}),e.jsx(w,{sx:{mb:3},children:e.jsx(G,{variant:"determinate",value:D(),sx:{height:8,borderRadius:4}})}),e.jsx(H,{dense:!0,children:p.map(t=>e.jsxs(J,{children:[e.jsx(N,{children:R(t.status)}),e.jsx(O,{primary:t.label,primaryTypographyProps:{color:t.status==="active"?"primary":"textPrimary"}})]},t.id))}),n==="timeout"&&e.jsxs(w,{sx:{mt:3,textAlign:"center"},children:[e.jsx(E,{variant:"contained",startIcon:e.jsx(Q,{}),onClick:()=>window.location.reload(),sx:{mr:2},children:"Reload Page"}),e.jsx(E,{variant:"outlined",onClick:()=>{b(0),l("polling"),o(null),f()},children:"Keep Waiting"})]})]})})}export{oe as default};
